{% extends 'base.html' %}

{% block head_title %}User Requests{% endblock %}

{% block base_content %}
{% with request.user as user %}
<h1>Upload Requests</h1>

<div class="requests">
    <table class="table request-table table-striped">
      	<thead class="thead-inverse">
            <tr>
                <th>Status</th>
                <th>File Name</th>
                <th>Date Uploaded</th>
                <th>Operation</th>
                <th>Actions</th>
            </tr>
      	</thead>
      	<tbody>
            {% for upload in uploads %}
            <tr>
                {% if upload.nstatus == 'COMPLETED' %}
                <td><span class="badge badge-success">Completed</span></td>
                {% elif upload.nstatus == 'QUEUED'  %}
                <td><span class="badge badge-primary">Queued</span></td>
                {% elif upload.nstatus == 'PROCESSING'  %}
                <td><span class="badge badge-primary">Processing</span></td>
                {% elif upload.nstatus == 'INCOMPLETE'  %}
                <td><span class="badge badge-info">Incomplete</span></td>
                {% elif upload.nstatus == 'FAILED' %}
                <td><span class="badge badge-danger">Failed</span></td>
                {% elif upload.nstatus == 'CANCELLED' %}
                <td><span class="badge badge-warning">Cancelled</span></td>
                {% else %}
                <td><span class="badge badge-default">Unknown</span></td>
                {% endif %}

                <td>{{ upload.filename }}</td>
                <td>{{ upload.created_at }}</td>

                {% if upload.is_update %}
                <td>
                    <span class="badge badge-info">Update</span>
                </td>
                {% else %}
                <td>
                    <span class="badge badge-primary">Create</span>
                </td>
                {% endif %}
                <td>
                    {% if upload.nstatus == 'COMPLETED' %}
                    <a class="btn btn-sm btn-success" href="{% url 'aoi_details' upload.get_objects_aoi_id %}" role="button"><i class="fa fa-eye" aria-hidden="true"></i> View AOI</a>
                    
                    {% elif upload.nstatus == 'QUEUED' or upload.nstatus == 'PROCESSING' or upload.nstatus == 'INCOMPLETE' %}
                    <form method="post" action="{% url 'account_requests_upload' %}">
                        {% csrf_token %}
                        <input name="cancel_upload" value="{{ upload.id }}" hidden="true">
                        <button class="btn btn-sm btn-warning" type="submit"><i class="fa fa-ban" aria-hidden="true"></i> Cancel</button>
                    </form>
                    
                    {% elif upload.nstatus == 'FAILED' %}
                    <button class="btn btn-sm btn-danger task-error-button" data-upload-filename="{{ upload.filename }}" data-upload-traceback="{{ upload.task.traceback|linebreaks }}"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> View Error</button>
                    
                    {% else %}
                    <span class="badge badge-default">N/A</span>
                    {% endif %}
                </td>
            </tr>
        	{% endfor %}
      	</tbody>
    </table>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" role="dialog">
</div>
{% include "./handlebars/taskerror.html" %}
{% endwith %}
{% endblock %}

{% block extra_body %}
<script type="text/javascript">
$(document).on('click', '.task-error-button', function(event){
    var button = this;
    context = {
        'upload_filename': $(button).attr('data-upload-filename'),
        'traceback': $(button).attr('data-upload-traceback')
    };
    makeErrorModal(context);
});

var errorModalTemplate = Handlebars.compile($('#taskerrormodal-template').html());
function makeErrorModal(context) {
    $("#errorModal").html(errorModalTemplate(context));
    $("#errorModal").modal("show");
}
</script>
{% endblock %}
